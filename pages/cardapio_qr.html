<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio Digital & QR Codes - SILVESS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--secondary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .mesa-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 2px solid transparent;
        }
        .mesa-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--secondary-color);
        }
        .mesa-numero {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
        }
        .mesa-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .qrcode-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .qrcode-container img {
            max-width: 200px;
            border: 3px solid var(--secondary-color);
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        .cardapio-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        .cardapio-item h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        .cardapio-item .preco {
            font-size: 20px;
            font-weight: 700;
            color: var(--success-color);
        }
        .disponibilidade-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--success-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container" style="padding: 30px 20px;">
        <div class="card">
            <h1 style="color: var(--primary-color); margin-bottom: 10px;">
                <i class="fas fa-qrcode"></i> Cardápio Digital & QR Codes
            </h1>
            <p style="color: var(--text-secondary);">Gerencie cardápios e QR codes das mesas</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('cardapios')">
                <i class="fas fa-book-open"></i> Cardápios
            </button>
            <button class="tab" onclick="switchTab('mesas')">
                <i class="fas fa-qrcode"></i> Mesas & QR Codes
            </button>
        </div>

        <!-- Tab: Cardápios -->
        <div class="tab-content active" id="tab-cardapios">
            <div class="card">
                <div class="section-header">
                    <h2 class="section-title">Gerenciar Cardápios</h2>
                    <button class="btn btn-primary" onclick="openCardapioModal()">
                        <i class="fas fa-plus"></i> Novo Cardápio
                    </button>
                </div>
                <div id="cardapiosList"></div>
            </div>
        </div>

        <!-- Tab: Mesas -->
        <div class="tab-content" id="tab-mesas">
            <div class="card">
                <div class="section-header">
                    <h2 class="section-title">Mesas & QR Codes</h2>
                    <button class="btn btn-primary" onclick="openMesaModal()">
                        <i class="fas fa-plus"></i> Nova Mesa
                    </button>
                </div>
                <div class="row" id="mesasList"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Novo Cardápio -->
    <div class="modal-overlay" id="cardapioModal" style="display: none;">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Novo Cardápio</h2>
                <button class="modal-close" onclick="closeCardapioModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="cardapioForm">
                    <div class="row">
                        <div class="col-8">
                            <div class="form-group">
                                <label class="form-label">Nome do Cardápio *</label>
                                <input type="text" class="form-control" id="nomeCardapio" required>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">Data *</label>
                                <input type="date" class="form-control" id="dataCardapio" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricaoCardapio" rows="2"></textarea>
                    </div>

                    <hr>

                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                        <i class="fas fa-utensils"></i> Pratos do Cardápio
                    </h3>

                    <div class="form-group">
                        <label class="form-label">Selecionar Pratos</label>
                        <select class="form-control" id="selectPrato" multiple size="8">
                            <!-- Será preenchido dinamicamente -->
                        </select>
                        <small style="color: var(--text-secondary);">
                            Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplos pratos
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCardapioModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarCardapio()">
                    <i class="fas fa-save"></i> Salvar Cardápio
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Nova Mesa -->
    <div class="modal-overlay" id="mesaModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Nova Mesa</h2>
                <button class="modal-close" onclick="closeMesaModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="mesaForm">
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">Número da Mesa *</label>
                                <input type="number" class="form-control" id="numeroMesa" min="1" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">Cardápio Associado</label>
                                <select class="form-control" id="cardapioMesa">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeMesaModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarMesa()">
                    <i class="fas fa-save"></i> Criar Mesa
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Visualizar QR Code -->
    <div class="modal-overlay" id="qrcodeModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">QR Code da Mesa</h2>
                <button class="modal-close" onclick="closeQRCodeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;" id="qrMesaNumero">Mesa #</h3>
                    <div class="qrcode-container" id="qrcodeDisplay"></div>
                    <p style="margin-top: 20px; color: var(--text-secondary);">
                        Escaneie este QR Code para visualizar o cardápio
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="imprimirQRCode()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeQRCodeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let fichasDisponiveis = [];
        let cardapiosDisponiveis = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            carregarCardapios();
            carregarMesas();
            carregarFichas();
            // Definir data padrão
            document.getElementById('dataCardapio').valueAsDate = new Date();
        });

        // Tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.closest('.tab').classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // ========== CARDÁPIOS ==========
        async function carregarCardapios() {
            try {
                const cardapios = await API.Cardapio.list({ ativo: 1 });
                cardapiosDisponiveis = cardapios;
                const lista = document.getElementById('cardapiosList');
                
                if (cardapios.length === 0) {
                    lista.innerHTML = '<p class="text-center">Nenhum cardápio cadastrado</p>';
                    return;
                }

                let html = '';
                for (const cardapio of cardapios) {
                    const detalhes = await API.Cardapio.getById(cardapio.id);
                    html += `
                        <div class="cardapio-item">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4><i class="fas fa-book-open"></i> ${cardapio.nome}</h4>
                                    <p style="color: var(--text-secondary); margin: 5px 0;">
                                        <i class="fas fa-calendar"></i> ${new Date(cardapio.data).toLocaleDateString('pt-BR')}
                                    </p>
                                    <p style="margin: 10px 0;">${cardapio.descricao || 'Sem descrição'}</p>
                                    <p style="font-weight: 600; color: var(--primary-color);">
                                        ${detalhes.pratos.length} pratos
                                    </p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-sm btn-primary" onclick="gerenciarPratos(${cardapio.id})">
                                        <i class="fas fa-edit"></i> Gerenciar
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deletarCardapio(${cardapio.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                lista.innerHTML = html;
            } catch (error) {
                Utils.showAlert('Erro ao carregar cardápios', 'danger');
            }
        }

        async function carregarFichas() {
            try {
                fichasDisponiveis = await API.Fichas.list({ ativo: 1 });
                const select = document.getElementById('selectPrato');
                select.innerHTML = '';
                
                fichasDisponiveis.forEach(ficha => {
                    select.innerHTML += `
                        <option value="${ficha.id}">
                            ${ficha.nome_prato} - ${Utils.formatCurrency(ficha.preco_venda)}
                        </option>
                    `;
                });
            } catch (error) {
                console.error('Erro ao carregar fichas:', error);
            }
        }

        function openCardapioModal() {
            document.getElementById('cardapioModal').style.display = 'flex';
            carregarFichas();
        }

        function closeCardapioModal() {
            document.getElementById('cardapioModal').style.display = 'none';
            document.getElementById('cardapioForm').reset();
        }

        async function salvarCardapio() {
            const nome = document.getElementById('nomeCardapio').value.trim();
            const data = document.getElementById('dataCardapio').value;
            const descricao = document.getElementById('descricaoCardapio').value.trim();
            const selectPrato = document.getElementById('selectPrato');
            const pratosSelecionados = Array.from(selectPrato.selectedOptions).map(opt => parseInt(opt.value));

            if (!nome || !data) {
                Utils.showAlert('Preencha nome e data', 'warning');
                return;
            }

            if (pratosSelecionados.length === 0) {
                Utils.showAlert('Selecione pelo menos um prato', 'warning');
                return;
            }

            try {
                const pratos = pratosSelecionados.map((id, index) => ({
                    ficha_tecnica_id: id,
                    disponivel: 1,
                    ordem: index
                }));

                await API.Cardapio.create({
                    nome,
                    data,
                    descricao,
                    ativo: 1,
                    pratos
                });

                Utils.showAlert('Cardápio criado com sucesso!', 'success');
                closeCardapioModal();
                carregarCardapios();
            } catch (error) {
                Utils.showAlert(error.message || 'Erro ao salvar cardápio', 'danger');
            }
        }

        async function deletarCardapio(id) {
            if (!confirm('Deseja realmente excluir este cardápio?')) return;

            try {
                await API.Cardapio.delete(id);
                Utils.showAlert('Cardápio excluído com sucesso!', 'success');
                carregarCardapios();
            } catch (error) {
                Utils.showAlert('Erro ao excluir cardápio', 'danger');
            }
        }

        function gerenciarPratos(cardapioId) {
            Utils.showAlert('Gerenciamento de pratos será implementado', 'info');
        }

        // ========== MESAS ==========
        async function carregarMesas() {
            try {
                const mesas = await API.Mesas.list();
                const lista = document.getElementById('mesasList');
                
                if (mesas.length === 0) {
                    lista.innerHTML = '<div class="col-12"><p class="text-center">Nenhuma mesa cadastrada</p></div>';
                    return;
                }

                let html = '';
                mesas.forEach(mesa => {
                    html += `
                        <div class="col-4">
                            <div class="mesa-card">
                                <div class="mesa-numero">
                                    <i class="fas fa-chair"></i> ${mesa.numero}
                                </div>
                                <div class="mesa-info">
                                    <p><strong>Cardápio:</strong> ${mesa.cardapio_nome || 'Não associado'}</p>
                                    ${mesa.cardapio_id ? `
                                        <button class="btn btn-primary mt-2" onclick="visualizarQRCode(${mesa.id}, ${mesa.numero})">
                                            <i class="fas fa-qrcode"></i> Ver QR Code
                                        </button>
                                    ` : ''}
                                </div>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="btn btn-sm btn-secondary" onclick="editarMesa(${mesa.id})">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                lista.innerHTML = html;
            } catch (error) {
                Utils.showAlert('Erro ao carregar mesas', 'danger');
            }
        }

        function openMesaModal() {
            document.getElementById('mesaModal').style.display = 'flex';
            // Carregar cardápios no select
            const select = document.getElementById('cardapioMesa');
            select.innerHTML = '<option value="">Selecione...</option>';
            cardapiosDisponiveis.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
            });
        }

        function closeMesaModal() {
            document.getElementById('mesaModal').style.display = 'none';
            document.getElementById('mesaForm').reset();
        }

        async function salvarMesa() {
            const numero = parseInt(document.getElementById('numeroMesa').value);
            const cardapioId = document.getElementById('cardapioMesa').value;

            if (!numero || numero < 1) {
                Utils.showAlert('Informe um número válido para a mesa', 'warning');
                return;
            }

            try {
                await API.Mesas.create({
                    numero,
                    cardapio_id: cardapioId || null,
                    ativo: 1
                });

                Utils.showAlert('Mesa criada com sucesso!', 'success');
                closeMesaModal();
                carregarMesas();
            } catch (error) {
                Utils.showAlert(error.message || 'Erro ao criar mesa', 'danger');
            }
        }

        async function visualizarQRCode(mesaId, mesaNumero) {
            try {
                const response = await API.Mesas.getQRCode(mesaId);
                
                document.getElementById('qrMesaNumero').textContent = `Mesa ${mesaNumero}`;
                document.getElementById('qrcodeDisplay').innerHTML = `
                    <img src="${response.qrcode_url}" alt="QR Code Mesa ${mesaNumero}">
                `;
                document.getElementById('qrcodeModal').style.display = 'flex';
            } catch (error) {
                Utils.showAlert('Erro ao carregar QR Code', 'danger');
            }
        }

        function closeQRCodeModal() {
            document.getElementById('qrcodeModal').style.display = 'none';
        }

        function imprimirQRCode() {
            window.print();
        }

        function editarMesa(id) {
            Utils.showAlert('Edição de mesa será implementada', 'info');
        }

        // Expor funções globalmente
        window.switchTab = switchTab;
        window.openCardapioModal = openCardapioModal;
        window.closeCardapioModal = closeCardapioModal;
        window.salvarCardapio = salvarCardapio;
        window.deletarCardapio = deletarCardapio;
        window.gerenciarPratos = gerenciarPratos;
        window.openMesaModal = openMesaModal;
        window.closeMesaModal = closeMesaModal;
        window.salvarMesa = salvarMesa;
        window.visualizarQRCode = visualizarQRCode;
        window.closeQRCodeModal = closeQRCodeModal;
        window.imprimirQRCode = imprimirQRCode;
        window.editarMesa = editarMesa;
    </script>
</body>
</html>
