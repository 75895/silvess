<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fichas Técnicas - SILVESS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .ingrediente-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ingrediente-info {
            flex: 1;
        }
        .ingrediente-actions {
            display: flex;
            gap: 10px;
        }
        .custo-summary {
            background: linear-gradient(135deg, var(--primary-color), #2c5282);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .custo-summary h3 {
            margin-bottom: 15px;
            font-size: 20px;
        }
        .custo-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .custo-row.total {
            font-size: 24px;
            font-weight: 700;
            border-top: 2px solid rgba(255,255,255,0.3);
            padding-top: 15px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Modal de Ficha Técnica -->
    <div class="modal-overlay" id="fichaModal" style="display: none;">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nova Ficha Técnica</h2>
                <button class="modal-close" onclick="closeFichaModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="fichaForm">
                    <div class="row">
                        <div class="col-8">
                            <div class="form-group">
                                <label class="form-label">Nome do Prato *</label>
                                <input type="text" class="form-control" id="nomePrato" required>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">Categoria</label>
                                <select class="form-control" id="categoria">
                                    <option value="">Selecione...</option>
                                    <option value="Entrada">Entrada</option>
                                    <option value="Prato Principal">Prato Principal</option>
                                    <option value="Acompanhamento">Acompanhamento</option>
                                    <option value="Sobremesa">Sobremesa</option>
                                    <option value="Bebida">Bebida</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">Porções *</label>
                                <input type="number" class="form-control" id="porcoes" value="1" min="1" required>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">Tempo Preparo (min)</label>
                                <input type="number" class="form-control" id="tempoPreparo" value="0" min="0">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">Validade (horas)</label>
                                <input type="number" class="form-control" id="validade" value="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Modo de Preparo</label>
                        <textarea class="form-control" id="modoPreparo" rows="4" 
                                  placeholder="Descreva o passo a passo do preparo..."></textarea>
                    </div>

                    <hr>

                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                        <i class="fas fa-balance-scale"></i> Ingredientes e Gramatura
                    </h3>

                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">Ingrediente</label>
                                <select class="form-control" id="selectIngrediente">
                                    <option value="">Selecione um ingrediente...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">Quantidade (gramas) *</label>
                                <input type="number" class="form-control" id="quantidadeGramas" 
                                       min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-success" style="width: 100%;" 
                                        onclick="adicionarIngrediente()">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="ingredientesList"></div>

                    <div class="custo-summary">
                        <h3><i class="fas fa-calculator"></i> Resumo de Custos</h3>
                        <div class="custo-row">
                            <span>Custo Total dos Ingredientes:</span>
                            <span id="custoTotal">R$ 0,00</span>
                        </div>
                        <div class="custo-row">
                            <span>Custo por Porção:</span>
                            <span id="custoPorcao">R$ 0,00</span>
                        </div>
                        <div class="custo-row total">
                            <span>Preço de Venda Sugerido (100% margem):</span>
                            <span id="precoSugerido">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">Preço de Venda (R$) *</label>
                                <input type="number" class="form-control" id="precoVenda" 
                                       min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">Margem de Lucro</label>
                                <input type="text" class="form-control" id="margemLucro" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFichaModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarFicha()">
                    <i class="fas fa-save"></i> Salvar Ficha Técnica
                </button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let ingredientesDisponiveis = [];
        let ingredientesSelecionados = [];
        let custoTotalCalculado = 0;

        // Carregar ingredientes disponíveis
        async function carregarIngredientes() {
            try {
                ingredientesDisponiveis = await API.Ingredientes.list({ ativo: 1 });
                const select = document.getElementById('selectIngrediente');
                select.innerHTML = '<option value="">Selecione um ingrediente...</option>';
                
                ingredientesDisponiveis.forEach(ing => {
                    select.innerHTML += `
                        <option value="${ing.id}" data-custo="${ing.custo_unitario}">
                            ${ing.nome} (${ing.unidade_medida}) - ${Utils.formatCurrency(ing.custo_unitario)}/kg
                        </option>
                    `;
                });
            } catch (error) {
                Utils.showAlert('Erro ao carregar ingredientes', 'danger');
            }
        }

        function adicionarIngrediente() {
            const selectIng = document.getElementById('selectIngrediente');
            const quantidadeGramas = parseFloat(document.getElementById('quantidadeGramas').value);

            if (!selectIng.value || !quantidadeGramas || quantidadeGramas <= 0) {
                Utils.showAlert('Selecione um ingrediente e informe a quantidade', 'warning');
                return;
            }

            const ingredienteId = parseInt(selectIng.value);
            const ingredienteNome = selectIng.options[selectIng.selectedIndex].text.split('(')[0].trim();
            const custoUnitario = parseFloat(selectIng.options[selectIng.selectedIndex].dataset.custo);

            // Verificar se já foi adicionado
            if (ingredientesSelecionados.find(i => i.ingrediente_id === ingredienteId)) {
                Utils.showAlert('Ingrediente já adicionado', 'warning');
                return;
            }

            // Calcular custo parcial (gramas / 1000 * custo por kg)
            const custoParcial = (quantidadeGramas / 1000) * custoUnitario;

            ingredientesSelecionados.push({
                ingrediente_id: ingredienteId,
                ingrediente_nome: ingredienteNome,
                quantidade_gramas: quantidadeGramas,
                custo_unitario: custoUnitario,
                custo_parcial: custoParcial
            });

            // Limpar campos
            selectIng.value = '';
            document.getElementById('quantidadeGramas').value = '';

            renderizarIngredientes();
            calcularCustos();
        }

        function removerIngrediente(index) {
            ingredientesSelecionados.splice(index, 1);
            renderizarIngredientes();
            calcularCustos();
        }

        function renderizarIngredientes() {
            const lista = document.getElementById('ingredientesList');
            
            if (ingredientesSelecionados.length === 0) {
                lista.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum ingrediente adicionado</p>';
                return;
            }

            let html = '';
            ingredientesSelecionados.forEach((ing, index) => {
                html += `
                    <div class="ingrediente-item">
                        <div class="ingrediente-info">
                            <strong>${ing.ingrediente_nome}</strong><br>
                            <small>
                                ${ing.quantidade_gramas}g × ${Utils.formatCurrency(ing.custo_unitario)}/kg = 
                                <strong>${Utils.formatCurrency(ing.custo_parcial)}</strong>
                            </small>
                        </div>
                        <div class="ingrediente-actions">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removerIngrediente(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            lista.innerHTML = html;
        }

        function calcularCustos() {
            custoTotalCalculado = ingredientesSelecionados.reduce((sum, ing) => sum + ing.custo_parcial, 0);
            const porcoes = parseInt(document.getElementById('porcoes').value) || 1;
            const custoPorcao = custoTotalCalculado / porcoes;
            const precoSugerido = custoTotalCalculado * 2; // 100% de margem

            document.getElementById('custoTotal').textContent = Utils.formatCurrency(custoTotalCalculado);
            document.getElementById('custoPorcao').textContent = Utils.formatCurrency(custoPorcao);
            document.getElementById('precoSugerido').textContent = Utils.formatCurrency(precoSugerido);

            calcularMargem();
        }

        function calcularMargem() {
            const precoVenda = parseFloat(document.getElementById('precoVenda').value) || 0;
            
            if (custoTotalCalculado > 0 && precoVenda > 0) {
                const margem = ((precoVenda - custoTotalCalculado) / custoTotalCalculado) * 100;
                document.getElementById('margemLucro').value = `${margem.toFixed(2)}%`;
            } else {
                document.getElementById('margemLucro').value = '0.00%';
            }
        }

        async function salvarFicha() {
            const nomePrato = document.getElementById('nomePrato').value.trim();
            const precoVenda = parseFloat(document.getElementById('precoVenda').value);

            if (!nomePrato) {
                Utils.showAlert('Informe o nome do prato', 'warning');
                return;
            }

            if (ingredientesSelecionados.length === 0) {
                Utils.showAlert('Adicione pelo menos um ingrediente', 'warning');
                return;
            }

            if (!precoVenda || precoVenda <= 0) {
                Utils.showAlert('Informe o preço de venda', 'warning');
                return;
            }

            const fichaData = {
                nome_prato: nomePrato,
                categoria: document.getElementById('categoria').value,
                descricao: document.getElementById('descricao').value,
                porcoes: parseInt(document.getElementById('porcoes').value),
                tempo_preparo: parseInt(document.getElementById('tempoPreparo').value),
                validade_horas: parseInt(document.getElementById('validade').value),
                modo_preparo: document.getElementById('modoPreparo').value,
                preco_venda: precoVenda,
                ingredientes: ingredientesSelecionados.map(ing => ({
                    ingrediente_id: ing.ingrediente_id,
                    quantidade_gramas: ing.quantidade_gramas
                }))
            };

            try {
                const response = await API.Fichas.create(fichaData);
                Utils.showAlert('Ficha técnica criada com sucesso!', 'success');
                closeFichaModal();
                // Recarregar lista se estiver na página de fichas
                if (typeof loadFichas === 'function') {
                    loadFichas();
                }
            } catch (error) {
                Utils.showAlert(error.message || 'Erro ao salvar ficha técnica', 'danger');
            }
        }

        function openFichaModal() {
            document.getElementById('fichaModal').style.display = 'flex';
            carregarIngredientes();
            ingredientesSelecionados = [];
            custoTotalCalculado = 0;
            renderizarIngredientes();
            calcularCustos();
            document.getElementById('fichaForm').reset();
        }

        function closeFichaModal() {
            document.getElementById('fichaModal').style.display = 'none';
        }

        // Event listeners
        document.getElementById('porcoes').addEventListener('input', calcularCustos);
        document.getElementById('precoVenda').addEventListener('input', calcularMargem);

        // Expor funções globalmente
        window.openFichaModal = openFichaModal;
        window.closeFichaModal = closeFichaModal;
        window.adicionarIngrediente = adicionarIngrediente;
        window.removerIngrediente = removerIngrediente;
        window.salvarFicha = salvarFicha;
    </script>
</body>
</html>
