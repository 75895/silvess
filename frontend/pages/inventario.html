<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventário - SILVESS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .inventario-header {
            background: linear-gradient(135deg, var(--primary-color), #2c5282);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .inventario-header h2 {
            margin-bottom: 10px;
        }
        .inventario-status {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-item i {
            font-size: 24px;
        }
        .inventario-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .inventario-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr 1fr;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }
        .inventario-row.header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        .inventario-row:hover:not(.header) {
            background-color: rgba(30, 58, 95, 0.05);
        }
        .input-fisica {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        .input-fisica:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        .input-fisica.editado {
            border-color: var(--warning-color);
            background-color: #fff3cd;
        }
        .diferenca {
            font-weight: 700;
            text-align: center;
        }
        .diferenca.positiva {
            color: var(--success-color);
        }
        .diferenca.negativa {
            color: var(--danger-color);
        }
        .diferenca.zero {
            color: var(--text-secondary);
        }
        .obs-input {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
        }
        .btn-salvar-item {
            padding: 8px 12px;
            font-size: 13px;
        }
        .resumo-inventario {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            margin-top: 30px;
        }
        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .resumo-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .resumo-card.total {
            background: linear-gradient(135deg, var(--info-color), #138496);
            color: white;
        }
        .resumo-card.diferencas {
            background: linear-gradient(135deg, var(--warning-color), #e0a800);
            color: white;
        }
        .resumo-card.valor {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
            color: white;
        }
        .resumo-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .resumo-card .valor {
            font-size: 32px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container" style="padding: 30px 20px;">
        <!-- Header -->
        <div class="inventario-header">
            <h2><i class="fas fa-clipboard-list"></i> Inventário Mensal</h2>
            <p>Controle e correção de estoque - Final do mês</p>
            <div class="inventario-status">
                <div class="status-item">
                    <i class="fas fa-calendar"></i>
                    <div>
                        <strong>Data:</strong> <span id="dataInventario">-</span>
                    </div>
                </div>
                <div class="status-item">
                    <i class="fas fa-boxes"></i>
                    <div>
                        <strong>Itens:</strong> <span id="totalItens">0</span>
                    </div>
                </div>
                <div class="status-item">
                    <i class="fas fa-edit"></i>
                    <div>
                        <strong>Status:</strong> <span id="statusInventario">Editável</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações -->
        <div class="card">
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <label class="form-label">Selecionar Data do Inventário</label>
                        <input type="date" class="form-control" id="selectDataInventario">
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="carregarInventario()">
                                <i class="fas fa-search"></i> Carregar Inventário
                            </button>
                            <button class="btn btn-success" onclick="gerarNovoInventario()">
                                <i class="fas fa-plus"></i> Gerar Novo
                            </button>
                            <button class="btn btn-warning" onclick="fecharInventario()" id="btnFechar" disabled>
                                <i class="fas fa-lock"></i> Fechar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Inventário -->
        <div class="inventario-table" id="inventarioTable">
            <div class="inventario-row header">
                <div>Ingrediente</div>
                <div style="text-align: center;">Unidade</div>
                <div style="text-align: center;">Qtd. Sistema</div>
                <div style="text-align: center;">Qtd. Física</div>
                <div style="text-align: center;">Diferença</div>
                <div>Observações</div>
                <div style="text-align: center;">Ações</div>
            </div>
            <div id="inventarioBody">
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                    <p>Selecione uma data e clique em "Carregar Inventário" ou "Gerar Novo"</p>
                </div>
            </div>
        </div>

        <!-- Resumo -->
        <div class="resumo-inventario" id="resumoInventario" style="display: none;">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                <i class="fas fa-chart-pie"></i> Resumo do Inventário
            </h3>
            <div class="resumo-grid">
                <div class="resumo-card total">
                    <h3>Total de Itens</h3>
                    <div class="valor" id="resumoTotalItens">0</div>
                </div>
                <div class="resumo-card diferencas">
                    <h3>Itens com Diferença</h3>
                    <div class="valor" id="resumoItensDiferenca">0</div>
                </div>
                <div class="resumo-card valor">
                    <h3>Valor das Diferenças</h3>
                    <div class="valor" id="resumoValorDiferencas">R$ 0,00</div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let inventarioAtual = [];
        let dataAtual = '';
        let editavel = true;

        // Definir data padrão (hoje)
        document.getElementById('selectDataInventario').valueAsDate = new Date();

        async function gerarNovoInventario() {
            const dataInput = document.getElementById('selectDataInventario').value;
            if (!dataInput) {
                Utils.showAlert('Selecione uma data', 'warning');
                return;
            }

            if (!confirm('Deseja gerar um novo inventário para esta data?')) {
                return;
            }

            try {
                const response = await API.Inventario.gerar(dataInput);
                Utils.showAlert(response.message, 'success');
                dataAtual = dataInput;
                await carregarInventario();
            } catch (error) {
                Utils.showAlert(error.message || 'Erro ao gerar inventário', 'danger');
            }
        }

        async function carregarInventario() {
            const dataInput = document.getElementById('selectDataInventario').value;
            if (!dataInput) {
                Utils.showAlert('Selecione uma data', 'warning');
                return;
            }

            try {
                const inventarios = await API.Inventario.list({ 
                    data_inicio: dataInput, 
                    data_fim: dataInput 
                });

                if (inventarios.length === 0) {
                    Utils.showAlert('Nenhum inventário encontrado para esta data', 'info');
                    return;
                }

                inventarioAtual = inventarios;
                dataAtual = dataInput;
                editavel = inventarios[0].editavel === 1;

                renderizarInventario();
                atualizarResumo();
                
                document.getElementById('btnFechar').disabled = !editavel;
                document.getElementById('statusInventario').textContent = editavel ? 'Editável' : 'Fechado';

            } catch (error) {
                Utils.showAlert(error.message || 'Erro ao carregar inventário', 'danger');
            }
        }

        function renderizarInventario() {
            const body = document.getElementById('inventarioBody');
            
            if (inventarioAtual.length === 0) {
                body.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                        <p>Nenhum item no inventário</p>
                    </div>
                `;
                return;
            }

            let html = '';
            inventarioAtual.forEach((item, index) => {
                const diferenca = item.diferenca !== null ? item.diferenca : 0;
                const diferencaClass = diferenca > 0 ? 'positiva' : diferenca < 0 ? 'negativa' : 'zero';
                const diferencaIcon = diferenca > 0 ? '▲' : diferenca < 0 ? '▼' : '●';
                const inputClass = item.quantidade_fisica !== null ? 'editado' : '';

                html += `
                    <div class="inventario-row">
                        <div><strong>${item.ingrediente_nome}</strong></div>
                        <div style="text-align: center;">${item.unidade_medida}</div>
                        <div style="text-align: center;">${item.quantidade_sistema.toFixed(2)}</div>
                        <div>
                            <input type="number" 
                                   class="input-fisica ${inputClass}" 
                                   id="fisica_${item.id}"
                                   value="${item.quantidade_fisica !== null ? item.quantidade_fisica : ''}"
                                   step="0.01"
                                   ${!editavel ? 'disabled' : ''}
                                   onchange="calcularDiferenca(${index}, ${item.id})">
                        </div>
                        <div class="diferenca ${diferencaClass}" id="dif_${item.id}">
                            ${diferenca !== 0 ? diferencaIcon + ' ' : ''}${Math.abs(diferenca).toFixed(2)}
                        </div>
                        <div>
                            <input type="text" 
                                   class="obs-input" 
                                   id="obs_${item.id}"
                                   value="${item.observacoes || ''}"
                                   placeholder="Observações..."
                                   ${!editavel ? 'disabled' : ''}>
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-sm btn-success btn-salvar-item" 
                                    onclick="salvarItem(${item.id}, ${index})"
                                    ${!editavel ? 'disabled' : ''}>
                                <i class="fas fa-save"></i> Salvar
                            </button>
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
            document.getElementById('dataInventario').textContent = new Date(dataAtual).toLocaleDateString('pt-BR');
            document.getElementById('totalItens').textContent = inventarioAtual.length;
            document.getElementById('resumoInventario').style.display = 'block';
        }

        function calcularDiferenca(index, itemId) {
            const fisica = parseFloat(document.getElementById(`fisica_${itemId}`).value) || 0;
            const sistema = inventarioAtual[index].quantidade_sistema;
            const diferenca = fisica - sistema;

            inventarioAtual[index].quantidade_fisica = fisica;
            inventarioAtual[index].diferenca = diferenca;

            const diferencaClass = diferenca > 0 ? 'positiva' : diferenca < 0 ? 'negativa' : 'zero';
            const diferencaIcon = diferenca > 0 ? '▲' : diferenca < 0 ? '▼' : '●';
            
            const difElement = document.getElementById(`dif_${itemId}`);
            difElement.className = `diferenca ${diferencaClass}`;
            difElement.textContent = `${diferenca !== 0 ? diferencaIcon + ' ' : ''}${Math.abs(diferenca).toFixed(2)}`;

            document.getElementById(`fisica_${itemId}`).classList.add('editado');
            atualizarResumo();
        }

        async function salvarItem(itemId, index) {
            const fisica = parseFloat(document.getElementById(`fisica_${itemId}`).value);
            const obs = document.getElementById(`obs_${itemId}`).value;

            if (isNaN(fisica) || fisica < 0) {
                Utils.showAlert('Informe uma quantidade física válida', 'warning');
                return;
            }

            const ajustarEstoque = confirm('Deseja ajustar o estoque do sistema com base na contagem física?');

            try {
                await API.Inventario.atualizar(itemId, fisica, obs, ajustarEstoque);
                Utils.showAlert('Item atualizado com sucesso!', 'success');
                
                if (ajustarEstoque) {
                    Utils.showAlert('Estoque do sistema foi ajustado', 'info');
                }
            } catch (error) {
                Utils.showAlert(error.message || 'Erro ao salvar item', 'danger');
            }
        }

        async function fecharInventario() {
            if (!confirm('Deseja fechar este inventário? Após fechado, não será mais possível editar.')) {
                return;
            }

            try {
                await API.Inventario.fechar(dataAtual);
                Utils.showAlert('Inventário fechado com sucesso!', 'success');
                editavel = false;
                await carregarInventario();
            } catch (error) {
                Utils.showAlert(error.message || 'Erro ao fechar inventário', 'danger');
            }
        }

        function atualizarResumo() {
            const totalItens = inventarioAtual.length;
            const itensDiferenca = inventarioAtual.filter(i => i.diferenca !== null && i.diferenca !== 0).length;
            
            // Calcular valor das diferenças (simplificado - assumindo custo médio)
            const valorDiferencas = inventarioAtual.reduce((sum, item) => {
                if (item.diferenca !== null && item.diferenca !== 0) {
                    // Valor aproximado baseado na diferença
                    return sum + Math.abs(item.diferenca * 10); // Placeholder
                }
                return sum;
            }, 0);

            document.getElementById('resumoTotalItens').textContent = totalItens;
            document.getElementById('resumoItensDiferenca').textContent = itensDiferenca;
            document.getElementById('resumoValorDiferencas').textContent = Utils.formatCurrency(valorDiferencas);
        }

        // Expor funções globalmente
        window.gerarNovoInventario = gerarNovoInventario;
        window.carregarInventario = carregarInventario;
        window.calcularDiferenca = calcularDiferenca;
        window.salvarItem = salvarItem;
        window.fecharInventario = fecharInventario;
    </script>
</body>
</html>
